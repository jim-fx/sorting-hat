function I(e){var o={},n,t=0,s,c,a=0,u,f="",_=String.fromCharCode,d=e.length,A="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(n=0;n<64;n++)o[A.charAt(n)]=n;for(c=0;c<d;c++)for(s=o[e.charAt(c)],t=(t<<6)+s,a+=6;a>=8;)((u=t>>>(a-=8)&255)||c<d-2)&&(f+=_(u));return f}function O(e){if(!e)return{};const o=e.split(".")[1],n=o==null?void 0:o.replace(/-/g,"+").replace(/_/g,"/");if(!n)return{};const t=I(n);return JSON.parse(t)}function R(e){return e[0].toUpperCase()+e.slice(1)}function p(e){return e&&typeof e=="object"&&!Array.isArray(e)}function h(e,...o){if(!o.length)return e;const n=o.shift();if(p(e)&&p(n))for(const t in n)p(n[t])?(e[t]||Object.assign(e,{[t]:{}}),h(e[t],n[t])):Object.assign(e,{[t]:n[t]});return h(e,...o)}function k(e){return e<.5?16*e*e*e*e*e:1-Math.pow(-2*e+2,5)/2}const{VITE_API_URL:m=""}={VITE_API_URL:"https://si21.herokuapp.com",VITE_SVELTEKIT_AMP:"",BASE_URL:"/_app/",MODE:"production",DEV:!1,PROD:!0};let i;const r={};function P(e){if(e in r)return r[e].forEach(o=>o());try{const{type:o,data:n}=JSON.parse(e);if(console.groupCollapsed("ws:received "+o,o in r),console.log(n),console.log(r),console.groupEnd(),o in r)return r[o].forEach(t=>t(n))}catch(o){console.error(o)}}let w;function g(){if(!("WebSocket"in globalThis))return;let e;w=new Promise(t=>e=t);let o=m||window.location.host;const n=window.location.protocol.includes("s");return i=new WebSocket(`ws${n?"s":""}://`+o.replace("https://","").replace("http://","")),i.onmessage=t=>{P(t.data)},i.onopen=()=>{console.log("Websocket Connected",r),e(),"open"in r&&setTimeout(()=>{r.open.forEach(t=>t(i))},200)},i.onclose=()=>{e(),setTimeout(async()=>{console.log("Reconnecting"),g()},500)},i}function L(e,o){return i||g(),r[e]=e in r?[...r[e],o]:[o],()=>{r[e]=r[e].filter(n=>n!==o)}}async function V(e,o){i||g(),await w,console.log("ws.emit",{type:e,data:o},i),i.send(JSON.stringify({type:e,data:o}))}const{VITE_API_URL:E=""}={VITE_API_URL:"https://si21.herokuapp.com",VITE_SVELTEKIT_AMP:"",BASE_URL:"/_app/",MODE:"production",DEV:!1,PROD:!0};let l,S=!1;async function T(e,{method:o,body:n,token:t}){const s={method:o};n&&(s.body=JSON.stringify(n));let c="localStorage"in globalThis?localStorage.getItem("jwt"):"";t&&(c=t),c&&(s.headers={Authentication:`Bearer ${t||c}`}),o==="POST"&&n&&("headers"in s||(s.headers={}),s.headers["Content-Type"]="application/json");const a=(E?E+"/":"/")+e;console.groupCollapsed("send."+o.toLowerCase(),a),console.log({body:n,token:t,headers:s.headers}),console.groupEnd();const u=await fetch(a,s);return u.status===401&&l&&(S=!0,l.update(f=>(f.role="",f))),u}function D(e,o){return T(e,{method:"GET",token:o})}function j(){if(console.log("register",l),"jwt"in localStorage&&l){if(S)return;const{jwt:e}=localStorage,{role:o,exp:n}=O(e);o==="ADMIN"&&(console.log("JWT expires",new Date(n*1e3)),console.log("ws.registerAdmin"),l.update(t=>(t.role=o,t)),V("admin",e))}}L("open",()=>{j()});function C(e){l=e}function y(e,o,n){return T(e,{method:"POST",body:o,token:n})}async function U(e,o){const n=await y("api/auth/login",{username:e,password:o});if(!n.ok)return!1;const{token:t}=await n.json();return t?(localStorage.setItem("jwt",t),!0):!1}export{k as a,R as c,O as d,V as e,D as g,U as l,h as m,L as o,y as p,C as s};
