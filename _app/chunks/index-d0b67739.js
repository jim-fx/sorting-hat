function O(e){var o={},n,t=0,r,c,a=0,l,u="",A=String.fromCharCode,g=e.length,I="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(n=0;n<64;n++)o[I.charAt(n)]=n;for(c=0;c<g;c++)for(r=o[e.charAt(c)],t=(t<<6)+r,a+=6;a>=8;)((l=t>>>(a-=8)&255)||c<g-2)&&(u+=A(l));return u}function m(e){if(!e)return{};const o=e.split(".")[1],n=o==null?void 0:o.replace(/-/g,"+").replace(/_/g,"/");if(!n)return{};const t=O(n);return JSON.parse(t)}function D(e){return e[0].toUpperCase()+e.slice(1)}function p(e){return e&&typeof e=="object"&&!Array.isArray(e)}function h(e,...o){if(!o.length)return e;const n=o.shift();if(p(e)&&p(n))for(const t in n)p(n[t])?(e[t]||Object.assign(e,{[t]:{}}),h(e[t],n[t])):Object.assign(e,{[t]:n[t]});return h(e,...o)}function R(e){return e<.5?16*e*e*e*e*e:1-Math.pow(-2*e+2,5)/2}const{VITE_API_URL:P=""}={VITE_API_URL:"https://si21.herokuapp.com",VITE_SVELTEKIT_AMP:"",BASE_URL:"/_app/",MODE:"production",DEV:!1,PROD:!0};let i;const s={};function j(e){if(e in s)return s[e].forEach(o=>o());try{const{type:o,data:n}=JSON.parse(e);if(console.groupCollapsed("ws:received "+o,o in s),console.log(n),console.log(s),console.groupEnd(),o in s)return s[o].forEach(t=>t(n))}catch(o){console.error(o)}}let w;function d(){if(!("WebSocket"in globalThis))return;let e;w=new Promise(t=>e=t);let o=P||window.location.host;const n=window.location.protocol.includes("s");return i=new WebSocket(`ws${n?"s":""}://`+o.replace("https://","").replace("http://","")),i.onmessage=t=>{j(t.data)},i.onopen=()=>{console.log("Websocket Connected",s),e(),"open"in s&&setTimeout(()=>{s.open.forEach(t=>t(i))},200)},i.onclose=()=>{e(),setTimeout(async()=>{console.log("Reconnecting"),d()},500)},i}function L(e,o){return i||d(),s[e]=e in s?[...s[e],o]:[o],()=>{s[e]=s[e].filter(n=>n!==o)}}async function V(e,o){i||d(),await w,console.log("ws.emit",{type:e,data:o},i),i.send(JSON.stringify({type:e,data:o}))}const{VITE_API_URL:S=""}={VITE_API_URL:"https://si21.herokuapp.com",VITE_SVELTEKIT_AMP:"",BASE_URL:"/_app/",MODE:"production",DEV:!1,PROD:!0};let f,E=!1;async function T(e,{method:o,body:n,token:t}){const r={method:o};n&&(r.body=JSON.stringify(n));let c="localStorage"in globalThis?localStorage.getItem("jwt"):"";t&&(c=t),c&&(r.headers={Authentication:`Bearer ${t||c}`}),o==="POST"&&n&&("headers"in r||(r.headers={}),r.headers["Content-Type"]="application/json");const a=(S?S+"/":"/")+e;console.groupCollapsed("send."+o.toLowerCase(),a),console.log({body:n,token:t,headers:r.headers}),console.groupEnd();const l=await fetch(a,r);return l.status===401&&f&&(E=!0,f.update(u=>(u.role="",u))),l}function k(e,o){return T(e,{method:"GET",token:o})}function _(){if("jwt"in localStorage&&f){if(E)return;const{jwt:e}=localStorage,{role:o,exp:n}=m(e),t=n*1e3<Date.now();if(o==="ADMIN"){if(t)console.log("jwt is expired");else{const r=new Date(n*1e3);console.log("JWT expires",r.getHours()+":"+r.getMinutes().toString().padStart(2,"0"))}f.update(r=>(t?r.role="":(console.log("ws.registerAdmin"),r.role=o),r)),V("admin",e)}}}L("open",()=>{_()});setTimeout(()=>{_()},1e3);function C(e){f=e}function y(e,o,n){return T(e,{method:"POST",body:o,token:n})}async function M(e,o){const n=await y("api/auth/login",{username:e,password:o});if(!n.ok)return!1;const{token:t}=await n.json();return t?(localStorage.setItem("jwt",t),!0):!1}export{R as a,D as c,m as d,V as e,k as g,M as l,h as m,L as o,y as p,C as s};
